<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 DualComm System - System Logs</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ESP32 DualComm System</h1>
            <h2>System Logs & Monitoring</h2>
        </header>
        
        <nav>
            <a href="index.html" onclick="onTabChange('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="sensors.html" onclick="onTabChange('sensors')"><i class="fas fa-thermometer-half"></i> Sensors</a>
            <a href="actuators.html" onclick="onTabChange('actuators')"><i class="fas fa-cogs"></i> Actuators</a>
            <a href="communication.html" onclick="onTabChange('communication')"><i class="fas fa-satellite-dish"></i> Communication</a>
            <a href="wifi.html" onclick="onTabChange('wifi')"><i class="fas fa-wifi"></i> WiFi Manager</a>
            <a href="ota.html" onclick="onTabChange('ota')"><i class="fas fa-upload"></i> OTA Updates</a>
            <a href="logs.html" class="active" onclick="onTabChange('logs')"><i class="fas fa-clipboard-list"></i> Logs</a>
            <a href="config.html" onclick="onTabChange('config')"><i class="fas fa-sliders-h"></i> Configuration</a>
        </nav>

        <div class="controls">
            <button class="btn-primary" onclick="loadLogs()">
                <i class="fas fa-sync-alt"></i> Refresh Logs
            </button>
            <button class="btn-success" onclick="exportLogs()">
                <i class="fas fa-download"></i> Export All
            </button>
            <button class="btn-danger" onclick="clearLogs()">
                <i class="fas fa-trash"></i> Clear Logs
            </button>
            <button class="btn-info" onclick="downloadLogFile()">
                <i class="fas fa-file-download"></i> Download Log File
            </button>
            
            <div style="display: flex; gap: var(--spacing-sm); margin-left: auto;">
                <button class="btn-secondary" onclick="toggleDarkMode()">
                    <i class="fas fa-moon"></i> Theme
                </button>
                <button class="btn-secondary" onclick="restartDevice()">
                    <i class="fas fa-redo"></i> Restart
                </button>
            </div>
        </div>

        <!-- Log Statistics -->
        <div class="stats-grid">
            <div class="stat-card fade-in" style="animation-delay: 0ms">
                <h4>Total Entries</h4>
                <div class="stat-value" id="total-logs">0</div>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                    <span class="label">Today:</span>
                    <span class="value" id="today-logs">0</span>
                </div>
            </div>
            
            <div class="stat-card fade-in" style="animation-delay: 100ms">
                <h4>Errors</h4>
                <div class="stat-value error" id="error-count">0</div>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                    <span class="label">Last 24h:</span>
                    <span class="value" id="error-24h">0</span>
                </div>
            </div>
            
            <div class="stat-card fade-in" style="animation-delay: 200ms">
                <h4>Warnings</h4>
                <div class="stat-value warning" id="warning-count">0</div>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                    <span class="label">Last 24h:</span>
                    <span class="value" id="warning-24h">0</span>
                </div>
            </div>
            
            <div class="stat-card fade-in" style="animation-delay: 300ms">
                <h4>System Health</h4>
                <div class="stat-value" id="log-health">--%</div>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                    <span class="label">Uptime:</span>
                    <span class="value" id="system-uptime">--</span>
                </div>
            </div>
        </div>

        <main>
            <!-- Log Filter Controls -->
            <div class="card fade-in" style="animation-delay: 400ms;">
                <div class="card-header">
                    <h2><i class="fas fa-filter"></i> Log Filtering</h2>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn-small btn-secondary" onclick="resetFilters()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <button class="btn-small btn-primary" onclick="applyFilters()">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                </div>
                <div style="padding: var(--spacing-lg);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-lg);">
                        <div>
                            <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                <i class="fas fa-layer-group"></i> Log Level
                            </label>
                            <select id="log-level" class="filter-select" multiple style="height: 120px;">
                                <option value="error" selected>üî¥ Error</option>
                                <option value="warning" selected>üü° Warning</option>
                                <option value="info" selected>üîµ Info</option>
                                <option value="debug" selected>‚ö™ Debug</option>
                                <option value="trace">‚ö´ Trace</option>
                            </select>
                            <div style="margin-top: var(--spacing-xs);">
                                <button class="btn-tiny" onclick="selectAllLevels()">Select All</button>
                                <button class="btn-tiny" onclick="deselectAllLevels()">Deselect All</button>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                <i class="fas fa-cube"></i> Module
                            </label>
                            <select id="log-module" class="filter-select" multiple style="height: 120px;">
                                <option value="system" selected>‚öôÔ∏è System</option>
                                <option value="wifi" selected>üì∂ WiFi</option>
                                <option value="sensors" selected>üå°Ô∏è Sensors</option>
                                <option value="actuators" selected>‚ö° Actuators</option>
                                <option value="espnow" selected>üì° ESP-NOW</option>
                                <option value="ota" selected>‚¨ÜÔ∏è OTA</option>
                                <option value="camera" selected>üì∑ Camera</option>
                                <option value="webserver" selected>üåê Web Server</option>
                            </select>
                            <div style="margin-top: var(--spacing-xs);">
                                <button class="btn-tiny" onclick="selectAllModules()">Select All</button>
                                <button class="btn-tiny" onclick="deselectAllModules()">Deselect All</button>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                <i class="fas fa-calendar"></i> Time Range
                            </label>
                            <select id="time-range" class="filter-select">
                                <option value="1h">Last 1 Hour</option>
                                <option value="6h" selected>Last 6 Hours</option>
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                            
                            <div style="margin-top: var(--spacing-md);">
                                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                    <i class="fas fa-sort-amount-down"></i> Sort Order
                                </label>
                                <select id="sort-order" class="filter-select">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                <i class="fas fa-search"></i> Search
                            </label>
                            <input type="text" id="log-search" placeholder="Search in logs..." 
                                   style="width: 100%; margin-bottom: var(--spacing-sm);">
                            
                            <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                <i class="fas fa-eye"></i> Display Options
                            </label>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <input type="checkbox" id="show-timestamp" checked>
                                    <span style="font-size: 0.875rem;">Show Timestamp</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <input type="checkbox" id="show-module" checked>
                                    <span style="font-size: 0.875rem;">Show Module</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <input type="checkbox" id="show-level" checked>
                                    <span style="font-size: 0.875rem;">Show Level</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <input type="checkbox" id="wrap-lines">
                                    <span style="font-size: 0.875rem;">Wrap Long Lines</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Log Viewer -->
            <div class="card fade-in" style="animation-delay: 450ms; margin-top: var(--spacing-xl);">
                <div class="card-header">
                    <h2><i class="fas fa-stream"></i> Real-time Log Viewer</h2>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <div class="status-indicator" id="logging-status">Stopped</div>
                        <button class="btn-small btn-success" onclick="toggleLogging()">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="btn-small btn-danger" onclick="toggleLogging()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button class="btn-small btn-secondary" onclick="clearLogViewer()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                        <label style="display: flex; align-items: center; gap: var(--spacing-sm); margin-left: var(--spacing-sm);">
                            <div class="switch">
                                <input type="checkbox" id="auto-scroll" checked>
                                <span class="slider"></span>
                            </div>
                            <span style="font-size: 0.875rem;">Auto-scroll</span>
                        </label>
                    </div>
                </div>
                <div id="log-viewer" class="log-container" style="height: 400px; font-family: var(--font-mono); font-size: 0.875rem;">
                    <div class="log-entry info">
                        <span class="log-time">00:00:00.000</span>
                        <span class="log-level">INFO</span>
                        <span class="log-module">SYSTEM</span>
                        <span class="log-message">Log viewer initialized. Ready to display logs.</span>
                    </div>
                </div>
                <div style="padding: var(--spacing-md); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                        <span id="log-count">1</span> entries displayed
                    </div>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn-tiny btn-secondary" onclick="scrollToTop()">
                            <i class="fas fa-angle-double-up"></i> Top
                        </button>
                        <button class="btn-tiny btn-secondary" onclick="scrollToBottom()">
                            <i class="fas fa-angle-double-down"></i> Bottom
                        </button>
                        <button class="btn-tiny btn-secondary" onclick="exportLogViewer()">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Analysis -->
            <div class="card fade-in" style="animation-delay: 500ms; margin-top: var(--spacing-xl);">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Log Analysis</h2>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn-small btn-info" onclick="analyzeLogs()">
                            <i class="fas fa-chart-line"></i> Analyze
                        </button>
                        <button class="btn-small btn-success" onclick="generateReport()">
                            <i class="fas fa-file-alt"></i> Generate Report
                        </button>
                    </div>
                </div>
                <div style="padding: var(--spacing-lg);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg);">
                        <!-- Level Distribution -->
                        <div>
                            <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                                <i class="fas fa-chart-pie"></i> Level Distribution
                            </h3>
                            <div id="level-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                <div>No data available. Click "Analyze" to generate chart.</div>
                            </div>
                        </div>
                        
                        <!-- Module Distribution -->
                        <div>
                            <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                                <i class="fas fa-sitemap"></i> Module Distribution
                            </h3>
                            <div id="module-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                <div>No data available. Click "Analyze" to generate chart.</div>
                            </div>
                        </div>
                        
                        <!-- Time Distribution -->
                        <div>
                            <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                                <i class="fas fa-clock"></i> Hourly Activity
                            </h3>
                            <div id="time-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                <div>No data available. Click "Analyze" to generate chart.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Error Sources -->
                    <div style="margin-top: var(--spacing-xl);">
                        <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                            <i class="fas fa-exclamation-circle"></i> Top Error Sources
                        </h3>
                        <div id="error-sources" style="min-height: 100px; padding: var(--spacing-md); background: rgba(255, 0, 85, 0.05); border-radius: var(--radius-md);">
                            <div style="text-align: center; color: var(--text-muted); padding: var(--spacing-lg);">
                                <i class="fas fa-info-circle"></i>
                                <p>No error data available. Run analysis to see error sources.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Settings -->
            <div class="card fade-in" style="animation-delay: 550ms; margin-top: var(--spacing-xl);">
                <div class="card-header">
                    <h2><i class="fas fa-cogs"></i> Log System Settings</h2>
                    <button class="btn-small btn-primary" onclick="saveLogSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
                <div style="padding: var(--spacing-lg);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg);">
                        <!-- Storage Settings -->
                        <div>
                            <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                                <i class="fas fa-database"></i> Storage Settings
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                                <div>
                                    <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                        Max Log Entries
                                    </label>
                                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                        <input type="range" id="max-entries" min="100" max="10000" value="1000" step="100"
                                               style="flex: 1;">
                                        <span id="max-entries-value" style="min-width: 60px;">1000</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                        Log Retention (days)
                                    </label>
                                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                        <input type="range" id="log-retention" min="1" max="90" value="7" step="1"
                                               style="flex: 1;">
                                        <span id="retention-value" style="min-width: 40px;">7</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                        Max File Size
                                    </label>
                                    <select id="max-file-size" class="filter-select">
                                        <option value="100">100 KB</option>
                                        <option value="500">500 KB</option>
                                        <option value="1000" selected>1 MB</option>
                                        <option value="5000">5 MB</option>
                                        <option value="10000">10 MB</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Output Settings -->
                        <div>
                            <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                                <i class="fas fa-broadcast-tower"></i> Output Settings
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <div class="switch">
                                        <input type="checkbox" id="enable-serial" checked>
                                        <span class="slider"></span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">Serial Output</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">Log to USB/Serial</div>
                                    </div>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <div class="switch">
                                        <input type="checkbox" id="enable-file" checked>
                                        <span class="slider"></span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">File Storage</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">Save logs to SD card</div>
                                    </div>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <div class="switch">
                                        <input type="checkbox" id="enable-websocket" checked>
                                        <span class="slider"></span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">WebSocket Streaming</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">Real-time web updates</div>
                                    </div>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <div class="switch">
                                        <input type="checkbox" id="enable-syslog">
                                        <span class="slider"></span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">Syslog Server</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">Send to remote syslog</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Log Level Settings -->
                        <div>
                            <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                                <i class="fas fa-sliders-h"></i> Log Level Settings
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                <div>
                                    <label style="display: block; margin-bottom: var(--spacing-xs); color: var(--text-muted); font-size: 0.875rem;">
                                        Global Log Level
                                    </label>
                                    <select id="global-log-level" class="filter-select">
                                        <option value="error">Error Only</option>
                                        <option value="warning">Warning & Error</option>
                                        <option value="info" selected>Info, Warning & Error</option>
                                        <option value="debug">Debug, Info, Warning & Error</option>
                                        <option value="trace">All Levels</option>
                                    </select>
                                </div>
                                
                                <div style="margin-top: var(--spacing-sm);">
                                    <label style="display: block; margin-bottom: var(--spacing-xs); color: var(--text-muted); font-size: 0.875rem;">
                                        Module-specific Levels
                                    </label>
                                    <div id="module-levels" style="max-height: 150px; overflow-y: auto; padding: var(--spacing-sm); background: rgba(255,255,255,0.03); border-radius: var(--radius-sm);">
                                        <!-- Module levels will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings -->
                    <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-lg); border-top: 1px solid var(--glass-border);">
                        <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                            <i class="fas fa-flask"></i> Advanced Settings
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
                            <div>
                                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                    Log Rotation
                                </label>
                                <select id="log-rotation" class="filter-select">
                                    <option value="daily">Daily</option>
                                    <option value="weekly" selected>Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="size">By Size</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                    Compression
                                </label>
                                <select id="log-compression" class="filter-select">
                                    <option value="none">None</option>
                                    <option value="gzip" selected>GZIP</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--text-muted);">
                                    Buffer Size
                                </label>
                                <select id="log-buffer" class="filter-select">
                                    <option value="1024">1 KB</option>
                                    <option value="4096">4 KB</option>
                                    <option value="8192" selected>8 KB</option>
                                    <option value="16384">16 KB</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                            <button class="btn-small btn-secondary" onclick="testLogging()">
                                <i class="fas fa-vial"></i> Test Logging
                            </button>
                            <button class="btn-small btn-info" onclick="rotateLogsNow()">
                                <i class="fas fa-sync-alt"></i> Rotate Logs Now
                            </button>
                            <button class="btn-small btn-warning" onclick="resetLogSettings()">
                                <i class="fas fa-undo"></i> Reset to Default
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Status Footer -->
        <footer style="margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--glass-bg); 
                     border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div id="status-indicator" class="status-indicator offline">
                        <span id="connection-status">Disconnected</span>
                    </div>
                    <div style="font-family: var(--font-mono); font-size: 0.875rem; color: var(--text-muted);">
                        <span>Last Update: </span>
                        <span id="last-update-time">--</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <span style="font-size: 0.875rem; color: var(--text-muted);">
                        <i class="fas fa-database"></i> Total Logs: <span id="total-logs-count">0</span>
                    </span>
                    <span style="font-size: 0.875rem; color: var(--text-muted);">
                        <i class="fas fa-hdd"></i> Storage: <span id="log-storage">--</span>
                    </span>
                    <span style="font-size: 0.875rem; color: var(--text-muted);">
                        <i class="fas fa-stream"></i> Rate: <span id="log-rate">0/min</span>
                    </span>
                </div>
                
                <div>
                    <button class="btn-small btn-secondary" onclick="connectWebSocket()">
                        <i class="fas fa-plug"></i> Reconnect
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <script>
        // Log-specific functions
        let loggingActive = false;
        let autoScrollEnabled = true;
        let logEntries = [];
        let filteredEntries = [];
        
        function loadLogs() {
            showToast('Loading logs...', 'info');
            
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    logEntries = data.logs || [];
                    updateLogStatistics();
                    applyFilters();
                    showToast(`Loaded ${logEntries.length} log entries`, 'success');
                    addActivityLog('Loaded system logs');
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    showToast('Failed to load logs', 'error');
                });
        }
        
        function exportLogs() {
            if (logEntries.length === 0) {
                showToast('No logs to export', 'warning');
                return;
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                totalEntries: logEntries.length,
                entries: logEntries
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `esp32_logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('Logs exported as JSON', 'success');
            addActivityLog('Exported all logs');
        }
        
        function downloadLogFile() {
            // Download the actual log file from ESP32
            window.open('/api/logs/download', '_blank');
            showToast('Downloading log file...', 'info');
            addActivityLog('Downloaded log file');
        }
        
        function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This cannot be undone.')) {
                return;
            }
            
            if (confirm('WARNING: This will delete ALL log entries. Continue?')) {
                fetch('/api/logs', { method: 'DELETE' })
                    .then(() => {
                        logEntries = [];
                        updateLogViewer();
                        updateLogStatistics();
                        showToast('All logs cleared', 'success');
                        addActivityLog('Cleared all system logs');
                    })
                    .catch(error => {
                        console.error('Error clearing logs:', error);
                        showToast('Failed to clear logs', 'error');
                    });
            }
        }
        
        function toggleLogging() {
            loggingActive = !loggingActive;
            const statusIndicator = document.getElementById('logging-status');
            const button = document.querySelector('[onclick="toggleLogging()"]');
            
            if (loggingActive) {
                statusIndicator.textContent = 'Active';
                statusIndicator.classList.add('online');
                statusIndicator.classList.remove('offline');
                button.innerHTML = '<i class="fas fa-stop"></i> Stop';
                showToast('Real-time logging started', 'success');
                addActivityLog('Started real-time logging');
            } else {
                statusIndicator.textContent = 'Stopped';
                statusIndicator.classList.add('offline');
                statusIndicator.classList.remove('online');
                button.innerHTML = '<i class="fas fa-play"></i> Start';
                showToast('Real-time logging stopped', 'warning');
                addActivityLog('Stopped real-time logging');
            }
        }
        
        function applyFilters() {
            const selectedLevels = Array.from(document.getElementById('log-level').selectedOptions)
                .map(option => option.value);
            const selectedModules = Array.from(document.getElementById('log-module').selectedOptions)
                .map(option => option.value);
            const timeRange = document.getElementById('time-range').value;
            const searchQuery = document.getElementById('log-search').value.toLowerCase();
            
            filteredEntries = logEntries.filter(entry => {
                // Level filter
                if (selectedLevels.length > 0 && !selectedLevels.includes(entry.level)) {
                    return false;
                }
                
                // Module filter
                if (selectedModules.length > 0 && !selectedModules.includes(entry.module)) {
                    return false;
                }
                
                // Time filter (simplified - in real app would use actual timestamps)
                if (timeRange !== 'all') {
                    // This would need actual timestamp logic
                    return true;
                }
                
                // Search filter
                if (searchQuery) {
                    const searchIn = `${entry.message} ${entry.module} ${entry.level}`.toLowerCase();
                    return searchIn.includes(searchQuery);
                }
                
                return true;
            });
            
            updateLogViewer();
        }
        
        function resetFilters() {
            document.getElementById('log-level').selectedIndex = -1;
            document.getElementById('log-module').selectedIndex = -1;
            document.getElementById('time-range').value = '6h';
            document.getElementById('log-search').value = '';
            applyFilters();
            showToast('Filters reset', 'info');
        }
        
        function selectAllLevels() {
            const options = document.getElementById('log-level').options;
            for (let i = 0; i < options.length; i++) {
                options[i].selected = true;
            }
        }
        
        function deselectAllLevels() {
            const options = document.getElementById('log-level').options;
            for (let i = 0; i < options.length; i++) {
                options[i].selected = false;
            }
        }
        
        function selectAllModules() {
            const options = document.getElementById('log-module').options;
            for (let i = 0; i < options.length; i++) {
                options[i].selected = true;
            }
        }
        
        function deselectAllModules() {
            const options = document.getElementById('log-module').options;
            for (let i = 0; i < options.length; i++) {
                options[i].selected = false;
            }
        }
        
        function updateLogViewer() {
            const logViewer = document.getElementById('log-viewer');
            const sortOrder = document.getElementById('sort-order').value;
            const showTimestamp = document.getElementById('show-timestamp').checked;
            const showModule = document.getElementById('show-module').checked;
            const showLevel = document.getElementById('show-level').checked;
            const wrapLines = document.getElementById('wrap-lines').checked;
            
            // Sort entries
            const sortedEntries = [...filteredEntries];
            if (sortOrder === 'newest') {
                sortedEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } else {
                sortedEntries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            }
            
            // Clear and repopulate
            logViewer.innerHTML = '';
            
            sortedEntries.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${entry.level}`;
                
                let html = '';
                if (showTimestamp) {
                    const time = new Date(entry.timestamp).toLocaleTimeString();
                    html += `<span class="log-time">${time}</span>`;
                }
                if (showLevel) {
                    const levelIcons = {
                        error: 'üî¥',
                        warning: 'üü°',
                        info: 'üîµ',
                        debug: '‚ö™',
                        trace: '‚ö´'
                    };
                    html += `<span class="log-level">${levelIcons[entry.level] || ''} ${entry.level.toUpperCase()}</span>`;
                }
                if (showModule) {
                    html += `<span class="log-module">${entry.module.toUpperCase()}</span>`;
                }
                html += `<span class="log-message" style="${wrapLines ? 'white-space: normal;' : 'white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'}">${entry.message}</span>`;
                
                logEntry.innerHTML = html;
                logViewer.appendChild(logEntry);
            });
            
            // Update count
            document.getElementById('log-count').textContent = sortedEntries.length;
            
            // Auto-scroll to bottom if enabled
            if (autoScrollEnabled && sortedEntries.length > 0) {
                setTimeout(() => {
                    logViewer.scrollTop = logViewer.scrollHeight;
                }, 100);
            }
        }
        
        function clearLogViewer() {
            if (!confirm('Clear the log viewer display? This does not delete logs.')) {
                return;
            }
            
            const logViewer = document.getElementById('log-viewer');
            logViewer.innerHTML = `
                <div class="log-entry info">
                    <span class="log-time">${new Date().toLocaleTimeString()}</span>
                    <span class="log-level">INFO</span>
                    <span class="log-module">SYSTEM</span>
                    <span class="log-message">Log viewer cleared</span>
                </div>
            `;
            
            showToast('Log viewer cleared', 'info');
        }
        
        function scrollToTop() {
            document.getElementById('log-viewer').scrollTop = 0;
        }
        
        function scrollToBottom() {
            const viewer = document.getElementById('log-viewer');
            viewer.scrollTop = viewer.scrollHeight;
        }
        
        function exportLogViewer() {
            const entries = Array.from(document.querySelectorAll('#log-viewer .log-entry'))
                .map(entry => entry.textContent.trim());
            
            const data = entries.join('\n');
            const blob = new Blob([data], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `log_viewer_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('Log viewer exported', 'success');
        }
        
        function analyzeLogs() {
            if (logEntries.length === 0) {
                showToast('No logs to analyze', 'warning');
                return;
            }
            
            // Level distribution
            const levelCounts = { error: 0, warning: 0, info: 0, debug: 0, trace: 0 };
            const moduleCounts = {};
            const hourlyCounts = Array(24).fill(0);
            
            logEntries.forEach(entry => {
                // Count levels
                levelCounts[entry.level] = (levelCounts[entry.level] || 0) + 1;
                
                // Count modules
                moduleCounts[entry.module] = (moduleCounts[entry.module] || 0) + 1;
                
                // Count by hour
                if (entry.timestamp) {
                    const hour = new Date(entry.timestamp).getHours();
                    hourlyCounts[hour]++;
                }
            });
            
            // Update level chart
            const levelChart = document.getElementById('level-chart');
            levelChart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); width: 100%;">
                    ${Object.entries(levelCounts).map(([level, count]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) var(--spacing-sm); background: rgba(255,255,255,0.03); border-radius: var(--radius-sm);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--${level}-color, var(--text-muted));"></div>
                                <span style="text-transform: capitalize;">${level}</span>
                            </div>
                            <span>${count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Update module chart
            const moduleChart = document.getElementById('module-chart');
            const sortedModules = Object.entries(moduleCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            moduleChart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm); width: 100%;">
                    ${sortedModules.map(([module, count]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) var(--spacing-sm); background: rgba(255,255,255,0.03); border-radius: var(--radius-sm);">
                            <span>${module}</span>
                            <span>${count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Update time chart
            const timeChart = document.getElementById('time-chart');
            timeChart.innerHTML = `
                <div style="display: flex; align-items: flex-end; gap: 2px; height: 100%; width: 100%;">
                    ${hourlyCounts.map((count, hour) => `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="width: 80%; background: var(--primary); border-radius: 2px; transition: height 0.5s ease;"
                                 style="height: ${(count / Math.max(...hourlyCounts)) * 100 || 5}%;"></div>
                            <span style="font-size: 0.75rem; margin-top: 4px;">${hour}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Update error sources
            const errorSources = document.getElementById('error-sources');
            const errors = logEntries.filter(entry => entry.level === 'error');
            
            if (errors.length > 0) {
                const errorModules = {};
                errors.forEach(error => {
                    errorModules[error.module] = (errorModules[error.module] || 0) + 1;
                });
                
                errorSources.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                        ${Object.entries(errorModules)
                            .sort((a, b) => b[1] - a[1])
                            .map(([module, count]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm); background: rgba(255,0,85,0.1); border-radius: var(--radius-sm);">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>
                                        <span>${module}</span>
                                    </div>
                                    <span style="color: var(--danger); font-weight: 600;">${count}</span>
                                </div>
                            `).join('')}
                    </div>
                `;
            }
            
            showToast('Log analysis complete', 'success');
            addActivityLog('Analyzed system logs');
        }
        
        function generateReport() {
            if (logEntries.length === 0) {
                showToast('No logs to generate report', 'warning');
                return;
            }
            
            const report = {
                generated: new Date().toISOString(),
                summary: {
                    totalEntries: logEntries.length,
                    errors: logEntries.filter(e => e.level === 'error').length,
                    warnings: logEntries.filter(e => e.level === 'warning').length,
                    info: logEntries.filter(e => e.level === 'info').length,
                    debug: logEntries.filter(e => e.level === 'debug').length
                },
                recentErrors: logEntries
                    .filter(e => e.level === 'error')
                    .slice(0, 10)
                    .map(e => ({
                        timestamp: e.timestamp,
                        module: e.module,
                        message: e.message
                    })),
                systemHealth: calculateLogHealth()
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `log_report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('Log report generated', 'success');
            addActivityLog('Generated log report');
        }
        
        function calculateLogHealth() {
            if (logEntries.length === 0) return 100;
            
            const recentLogs = logEntries.slice(-100); // Last 100 entries
            const errorCount = recentLogs.filter(e => e.level === 'error').length;
            const warningCount = recentLogs.filter(e => e.level === 'warning').length;
            
            let health = 100;
            health -= errorCount * 10; // -10% per error
            health -= warningCount * 5; // -5% per warning
            health = Math.max(0, Math.min(100, health));
            
            document.getElementById('log-health').textContent = health + '%';
            return health;
        }
        
        function updateLogStatistics() {
            const total = logEntries.length;
            const errors = logEntries.filter(e => e.level === 'error').length;
            const warnings = logEntries.filter(e => e.level === 'warning').length;
            const info = logEntries.filter(e => e.level === 'info').length;
            
            // Today's logs (simplified - would use actual dates in real app)
            const today = logEntries.slice(0, Math.floor(total * 0.1)).length;
            
            document.getElementById('total-logs').textContent = total;
            document.getElementById('error-count').textContent = errors;
            document.getElementById('warning-count').textContent = warnings;
            document.getElementById('info-count').textContent = info;
            document.getElementById('today-logs').textContent = today;
            document.getElementById('error-24h').textContent = Math.floor(errors * 0.2);
            document.getElementById('warning-24h').textContent = Math.floor(warnings * 0.2);
            
            calculateLogHealth();
        }
        
        function saveLogSettings() {
            const settings = {
                maxEntries: document.getElementById('max-entries').value,
                retention: document.getElementById('log-retention').value,
                maxFileSize: document.getElementById('max-file-size').value,
                enableSerial: document.getElementById('enable-serial').checked,
                enableFile: document.getElementById('enable-file').checked,
                enableWebsocket: document.getElementById('enable-websocket').checked,
                enableSyslog: document.getElementById('enable-syslog').checked,
                globalLevel: document.getElementById('global-log-level').value,
                rotation: document.getElementById('log-rotation').value,
                compression: document.getElementById('log-compression').value,
                buffer: document.getElementById('log-buffer').value
            };
            
            localStorage.setItem('logSettings', JSON.stringify(settings));
            
            // Send to ESP32
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWSMessage({
                    type: 'updateLogSettings',
                    settings: settings
                });
            }
            
            showToast('Log settings saved', 'success');
            addActivityLog('Saved log settings');
        }
        
        function resetLogSettings() {
            if (!confirm('Reset all log settings to defaults?')) return;
            
            // Reset UI elements
            document.getElementById('max-entries').value = 1000;
            document.getElementById('max-entries-value').textContent = '1000';
            document.getElementById('log-retention').value = 7;
            document.getElementById('retention-value').textContent = '7';
            document.getElementById('max-file-size').value = 1000;
            document.getElementById('enable-serial').checked = true;
            document.getElementById('enable-file').checked = true;
            document.getElementById('enable-websocket').checked = true;
            document.getElementById('enable-syslog').checked = false;
            document.getElementById('global-log-level').value = 'info';
            document.getElementById('log-rotation').value = 'weekly';
            document.getElementById('log-compression').value = 'gzip';
            document.getElementById('log-buffer').value = 8192;
            
            localStorage.removeItem('logSettings');
            showToast('Log settings reset to defaults', 'info');
            addActivityLog('Reset log settings');
        }
        
        function testLogging() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWSMessage({
                    type: 'testLogging'
                });
                showToast('Test log entry generated', 'info');
                addActivityLog('Generated test log entry');
            }
        }
        
        function rotateLogsNow() {
            if (confirm('Rotate log files now? Current logs will be archived.')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendWSMessage({
                        type: 'rotateLogs'
                    });
                    showToast('Log rotation initiated', 'info');
                    addActivityLog('Initiated log rotation');
                }
            }
        }
        
        // Initialize logs page
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings
            const savedSettings = localStorage.getItem('logSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                // Apply settings to UI elements
                // (Implementation depends on actual UI structure)
            }
            
            // Set up auto-scroll toggle
            const autoScrollToggle = document.getElementById('auto-scroll');
            if (autoScrollToggle) {
                autoScrollToggle.addEventListener('change', function() {
                    autoScrollEnabled = this.checked;
                    showToast(`Auto-scroll ${this.checked ? 'enabled' : 'disabled'}`, 'info');
                });
            }
            
            // Update range value displays
            const maxEntriesInput = document.getElementById('max-entries');
            const maxEntriesValue = document.getElementById('max-entries-value');
            if (maxEntriesInput && maxEntriesValue) {
                maxEntriesInput.addEventListener('input', function() {
                    maxEntriesValue.textContent = this.value;
                });
            }
            
            const retentionInput = document.getElementById('log-retention');
            const retentionValue = document.getElementById('retention-value');
            if (retentionInput && retentionValue) {
                retentionInput.addEventListener('input', function() {
                    retentionValue.textContent = this.value;
                });
            }
            
            // Initialize module levels
            const modules = ['system', 'wifi', 'sensors', 'actuators', 'espnow', 'ota', 'camera', 'webserver'];
            const moduleLevelsContainer = document.getElementById('module-levels');
            if (moduleLevelsContainer) {
                moduleLevelsContainer.innerHTML = modules.map(module => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) 0;">
                        <span style="font-size: 0.875rem;">${module}</span>
                        <select style="font-size: 0.875rem; padding: 2px 4px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: var(--radius-sm);">
                            <option value="error">Error</option>
                            <option value="warning">Warning</option>
                            <option value="info" selected>Info</option>
                            <option value="debug">Debug</option>
                        </select>
                    </div>
                `).join('');
            }
            
            // Load initial logs
            loadLogs();
            
            // Initialize activity log
            addActivityLog('Log monitoring module loaded');
            addActivityLog('Real-time log viewer initialized');
            
            // Auto-refresh logs every 30 seconds
            setInterval(() => {
                if (loggingActive) {
                    // Simulate receiving new logs
                    updateLogStatistics();
                }
            }, 30000);
        });
    </script>

    <!-- Include the main JavaScript file -->
    <script src="script.js"></script>
</body>
</html>