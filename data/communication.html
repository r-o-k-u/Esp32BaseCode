<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 DualComm System - Communication</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ESP32 DualComm System</h1>
            <h2>Communication Center</h2>
        </header>
        
        <nav>
            <a href="index.html" onclick="onTabChange('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="sensors.html" onclick="onTabChange('sensors')"><i class="fas fa-thermometer-half"></i> Sensors</a>
            <a href="actuators.html" onclick="onTabChange('actuators')"><i class="fas fa-cogs"></i> Actuators</a>
            <a href="communication.html" class="active" onclick="onTabChange('communication')"><i class="fas fa-satellite-dish"></i> Communication</a>
            <a href="wifi.html" onclick="onTabChange('wifi')"><i class="fas fa-wifi"></i> WiFi Manager</a>
            <a href="ota.html" onclick="onTabChange('ota')"><i class="fas fa-upload"></i> OTA Updates</a>
            <a href="logs.html" onclick="onTabChange('logs')"><i class="fas fa-clipboard-list"></i> Logs</a>
            <a href="config.html" onclick="onTabChange('config')"><i class="fas fa-sliders-h"></i> Configuration</a>
        </nav>

        <div class="comm-controls">
            <button class="btn-primary" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> Refresh All
            </button>
            <button class="btn-success" onclick="refreshPeers()">
                <i class="fas fa-search"></i> Scan ESP-NOW
            </button>
            <button class="btn-info" onclick="scanWiFiNetworks()">
                <i class="fas fa-wifi"></i> Scan WiFi
            </button>
            <button class="btn-danger" onclick="emergencyStop()">
                <i class="fas fa-skull-crossbones"></i> Emergency Stop
            </button>
            <div style="display: flex; gap: var(--spacing-sm); margin-left: auto;">
                <button class="btn-secondary" onclick="toggleDarkMode()">
                    <i class="fas fa-moon"></i> Theme
                </button>
                <button class="btn-secondary" onclick="restartDevice()">
                    <i class="fas fa-redo"></i> Restart
                </button>
            </div>
        </div>

        <main>
            <!-- Status Overview -->
            <div class="stats-grid">
                <div class="stat-card fade-in" style="animation-delay: 0ms">
                    <h4>WiFi Status</h4>
                    <div class="stat-value" id="wifi-quick-status">--</div>
                    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                        <span class="label">IP:</span>
                        <span class="value" id="wifi-quick-ip">--</span>
                    </div>
                </div>
                
                <div class="stat-card fade-in" style="animation-delay: 100ms">
                    <h4>ESP-NOW Status</h4>
                    <div class="stat-value" id="espnow-quick-peers">--</div>
                    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                        <span class="label">Channel:</span>
                        <span class="value" id="espnow-quick-channel">--</span>
                    </div>
                </div>
                
                <div class="stat-card fade-in" style="animation-delay: 200ms">
                    <h4>Messages</h4>
                    <div class="stat-value" id="message-count">--</div>
                    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                        <span class="label">Last:</span>
                        <span class="value" id="last-message-time">--</span>
                    </div>
                </div>
                
                <div class="stat-card fade-in" style="animation-delay: 300ms">
                    <h4>System Health</h4>
                    <div class="stat-value" id="comm-health">--</div>
                    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                        <span class="label">Uptime:</span>
                        <span class="value" id="system-uptime">--</span>
                    </div>
                </div>
            </div>

            <!-- ESP-NOW Communication -->
            <div class="card fade-in" style="animation-delay: 400ms">
                <div class="card-header">
                    <h2><i class="fas fa-broadcast-tower"></i> ESP-NOW Communication</h2>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn-small btn-success" onclick="refreshPeers()">
                            <i class="fas fa-search"></i> Scan
                        </button>
                        <button class="btn-small btn-info" onclick="clearMessageLog()">
                            <i class="fas fa-trash"></i> Clear Log
                        </button>
                        <button class="btn-small btn-warning" onclick="toggleActuator('espnow', true)">
                            <i class="fas fa-power-off"></i> Restart
                        </button>
                    </div>
                </div>
                <div style="padding: var(--spacing-lg);">
                    <!-- ESP-NOW Status -->
                    <div class="sensor-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: var(--spacing-lg);">
                        <div class="data-item">
                            <span class="label">Status:</span>
                            <span id="espnow-status" class="value offline">Offline</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Channel:</span>
                            <span id="espnow-channel" class="value">-</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Active Peers:</span>
                            <span id="espnow-peers" class="value">0</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Packets Sent:</span>
                            <span id="espnow-sent" class="value">0</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Packets Received:</span>
                            <span id="espnow-received" class="value">0</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Failed:</span>
                            <span id="espnow-failed" class="value">0</span>
                        </div>
                    </div>

                    <!-- Peer Management -->
                    <div style="background: var(--glass-bg); padding: var(--spacing-lg); border-radius: var(--radius-lg); margin-bottom: var(--spacing-lg);">
                        <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                            <i class="fas fa-users"></i> Peer Management
                        </h3>
                        
                        <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); flex-wrap: wrap;">
                            <input type="text" id="peer-mac-input" placeholder="XX:XX:XX:XX:XX:XX" 
                                   style="flex: 1; min-width: 200px;">
                            <input type="text" id="peer-name-input" placeholder="Peer Name (optional)" 
                                   style="flex: 1; min-width: 150px;">
                            <button class="btn-primary" onclick="addPeer()">
                                <i class="fas fa-plus"></i> Add Peer
                            </button>
                        </div>

                        <div id="peer-list" class="peer-list">
                            <div class="empty-state">
                                <i class="fas fa-user-slash"></i>
                                <p>No peers found. Click "Scan" to discover nearby devices.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Sending -->
                    <div style="background: var(--glass-bg); padding: var(--spacing-lg); border-radius: var(--radius-lg);">
                        <h3 style="margin-bottom: var(--spacing-md); color: var(--primary);">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </h3>
                        
                        <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md); flex-wrap: wrap;">
                            <select id="peer-select" style="flex: 1; min-width: 200px;">
                                <option value="">Select peer...</option>
                                <option value="broadcast">ðŸ“¢ Broadcast to All</option>
                            </select>
                            
                            <select id="message-type" style="flex: 0 0 150px;">
                                <option value="text">Text Message</option>
                                <option value="sensor">Sensor Data</option>
                                <option value="command">Command</option>
                                <option value="json">JSON</option>
                            </select>
                            
                            <input type="text" id="message-input" placeholder="Enter message..." 
                                   style="flex: 2; min-width: 250px;">
                            
                            <button class="btn-primary" onclick="sendMessageToPeer()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                        
                        <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                            <button class="btn-small btn-info" onclick="quickCommand('sensor_request')">
                                <i class="fas fa-thermometer"></i> Request Sensors
                            </button>
                            <button class="btn-small btn-info" onclick="quickCommand('status_request')">
                                <i class="fas fa-info-circle"></i> Request Status
                            </button>
                            <button class="btn-small btn-info" onclick="quickCommand('identify')">
                                <i class="fas fa-fingerprint"></i> Identify
                            </button>
                            <button class="btn-small btn-warning" onclick="quickCommand('emergency_stop')">
                                <i class="fas fa-stop-circle"></i> Emergency Stop
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Log -->
            <div class="card fade-in" style="animation-delay: 500ms; margin-top: var(--spacing-lg);">
                <div class="card-header">
                    <h2><i class="fas fa-clipboard-list"></i> Message Log</h2>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn-small btn-danger" onclick="clearMessageLog()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button class="btn-small btn-info" onclick="exportMessageLog()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span style="font-size: 0.875rem; color: var(--text-muted);">Auto-refresh:</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-refresh-log" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div style="padding: var(--spacing-lg);">
                    <div id="message-log" class="message-log">
                        <div class="message-item">
                            <span class="message-time">00:00:00</span>
                            <span class="message-direction info">INFO</span>
                            <span class="message-content">Communication system initialized. Ready to send and receive messages.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WiFi Communication (Quick Overview) -->
            <div class="card fade-in" style="animation-delay: 600ms; margin-top: var(--spacing-lg);">
                <div class="card-header">
                    <h2><i class="fas fa-wifi"></i> WiFi Communication</h2>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn-small btn-success" onclick="location.href='wifi.html'">
                            <i class="fas fa-external-link-alt"></i> WiFi Manager
                        </button>
                        <button class="btn-small btn-info" onclick="loadWiFiStatus()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div style="padding: var(--spacing-lg);">
                    <div class="sensor-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom: var(--spacing-lg);">
                        <div class="data-item">
                            <span class="label">Status:</span>
                            <span id="wifi-status" class="value offline">Disconnected</span>
                        </div>
                        <div class="data-item">
                            <span class="label">SSID:</span>
                            <span id="wifi-ssid" class="value">-</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Signal:</span>
                            <span id="wifi-signal" class="value">-</span>
                        </div>
                        <div class="data-item">
                            <span class="label">IP Address:</span>
                            <span id="wifi-ip" class="value">-</span>
                        </div>
                        <div class="data-item">
                            <span class="label">MAC Address:</span>
                            <span id="wifi-mac" class="value">-</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Gateway:</span>
                            <span id="wifi-gateway" class="value">-</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--spacing-lg); background: rgba(0, 255, 255, 0.05); border-radius: var(--radius-lg);">
                        <h3 style="color: var(--primary); margin-bottom: var(--spacing-md);">
                            <i class="fas fa-external-link-alt"></i> Need WiFi Management?
                        </h3>
                        <p style="margin-bottom: var(--spacing-lg); color: var(--text-secondary);">
                            Use the WiFi Manager for advanced features: network scanning, connection management, 
                            and access point configuration.
                        </p>
                        <button class="btn-primary" onclick="location.href='wifi.html'">
                            <i class="fas fa-wifi"></i> Open WiFi Manager
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Connection Status Footer -->
        <footer style="margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--glass-bg); 
                     border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div id="status-indicator" class="status-indicator offline">
                        <span id="connection-status">Disconnected</span>
                    </div>
                    <div style="font-family: var(--font-mono); font-size: 0.875rem; color: var(--text-muted);">
                        <span id="current-time">00:00:00</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <span style="font-size: 0.875rem; color: var(--text-muted);">
                        <i class="fas fa-microchip"></i> Heap: <span id="footer-memory">--</span>
                    </span>
                    <span style="font-size: 0.875rem; color: var(--text-muted);">
                        <i class="fas fa-clock"></i> Uptime: <span id="footer-uptime">--</span>
                    </span>
                    <span style="font-size: 0.875rem; color: var(--text-muted);">
                        <i class="fas fa-satellite"></i> ESP-NOW: <span id="footer-espnow">--</span>
                    </span>
                </div>
                
                <div>
                    <button class="btn-small btn-secondary" onclick="connectWebSocket()">
                        <i class="fas fa-plug"></i> Reconnect
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <script>
        // Communication-specific functions
        function addPeer() {
            const mac = document.getElementById('peer-mac-input').value.trim();
            const name = document.getElementById('peer-name-input').value.trim();
            
            if (!mac || !validateMAC(mac)) {
                showToast('Please enter a valid MAC address (XX:XX:XX:XX:XX:XX)', 'warning');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWSMessage({
                    type: 'addPeer',
                    mac: mac,
                    name: name || `Peer_${mac.substring(12)}`
                });
                
                document.getElementById('peer-mac-input').value = '';
                document.getElementById('peer-name-input').value = '';
                showToast('Peer added successfully', 'success');
                addActivityLog(`Added peer: ${mac}`);
            } else {
                showToast('Not connected to device', 'error');
            }
        }
        
        function validateMAC(mac) {
            const macRegex = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
            return macRegex.test(mac);
        }
        
        function quickCommand(command) {
            const peerSelect = document.getElementById('peer-select');
            const peer = peerSelect.value;
            
            if (!peer && command !== 'broadcast') {
                showToast('Please select a peer first', 'warning');
                return;
            }
            
            const commands = {
                'sensor_request': { type: 'sensor_request' },
                'status_request': { type: 'status_request' },
                'identify': { type: 'identify', action: 'blink' },
                'emergency_stop': { type: 'emergency_stop' }
            };
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWSMessage({
                    type: 'sendToPeer',
                    peer: peer || 'broadcast',
                    message: commands[command]
                });
                
                showToast(`Command sent: ${command}`, 'success');
                addActivityLog(`Sent ${command} command to ${peer || 'all peers'}`);
            }
        }
        
        function exportMessageLog() {
            const messages = Array.from(document.querySelectorAll('.message-item')).map(item => ({
                time: item.querySelector('.message-time').textContent,
                direction: item.querySelector('.message-direction').textContent,
                content: item.querySelector('.message-content').textContent
            }));
            
            const data = {
                timestamp: new Date().toISOString(),
                totalMessages: messages.length,
                messages: messages
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `esp32_messages_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('Message log exported', 'success');
            addActivityLog('Exported message log');
        }
        
        // Auto-refresh for message log
        let logRefreshInterval;
        const autoRefreshToggle = document.getElementById('auto-refresh-log');
        
        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('change', function() {
                if (this.checked) {
                    startLogRefresh();
                } else {
                    stopLogRefresh();
                }
            });
            
            startLogRefresh();
        }
        
        function startLogRefresh() {
            if (logRefreshInterval) clearInterval(logRefreshInterval);
            logRefreshInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendWSMessage({ type: 'getPeers' });
                }
            }, 30000); // Refresh every 30 seconds
        }
        
        function stopLogRefresh() {
            if (logRefreshInterval) {
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
            }
        }
        
        // Initialize communication-specific elements
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard shortcut for sending messages (Ctrl+Enter)
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        sendMessageToPeer();
                    }
                });
            }
            
            // Update clock in footer
            function updateClock() {
                const element = document.getElementById('current-time');
                if (element) {
                    const now = new Date();
                    element.textContent = now.toLocaleTimeString();
                }
            }
            
            updateClock();
            setInterval(updateClock, 1000);
            
            // Initialize activity log
            addActivityLog('Communication module loaded');
        });
    </script>

    <!-- Include the main JavaScript file -->
    <script src="script.js"></script>
</body>
</html>